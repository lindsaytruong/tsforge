---
title: "plot_timeseries"
subtitle: "TSForge Tutorial — plot_timeseries() Deep Dive"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    code-tools: true
    embed-resources: true   # required for Plotly
execute:
  enabled: true
  echo: true
  warning: false
  message: false
jupyter: python3            # required to run Python code
---

# 1. Introduction

`plot_timeseries()` is TSForge’s **flagship visualization engine** — a modular, enterprise-grade Plotly interface that supports:

- Overlay, facet, and dropdown views  
- Hierarchical time series  
- Global & local events  
- Anomalies  
- Forecasts + prediction intervals  
- Multiple professional themes  
- Smoothing  
- Auto-selection of IDs when a dataset is large  

This tutorial walks through the complete workflow using synthetic but realistic data.
---

# 2. Architecture Diagram

```mermaid
flowchart TB

A[Input DataFrames] --> B[Group / Aggregate]
B --> C[Resample]
C --> D[Select IDs]
D --> E[Smoothing]
E --> F[Merge Events]
F --> G[Normalize Anomalies]
G --> H[Render Mode<br>overlay/facet/dropdown]
H --> I[Theme + Styling]
I --> J[Plotly Figure]
```

---

# 3. Load Libraries

```{python}
import pandas as pd
import numpy as np

from tsforge.plots.charts import plot_timeseries
from tsforge.plots.core.theme import THEMES
```

# 4. Build a Hierarhical Dataset.

Most forecasting datasets include levels such as:

- Department
- Item
- Store

Below we construct a dataset with:

- unique_id — BEV_1, BEV_2, SNK_1, SNK_2
- department — BEV or SNK
- ds — date
- y — actual daily sales

```{python}
# For reproducibility
rng = np.random.default_rng(42)

# -----------------------------
# ACTUALS: df_actuals
# -----------------------------
dates = pd.date_range("2020-01-01", periods=90, freq="D")
ids = ["FOODS_1", "BEV_2", "DAIRY_3"]

rows = []
for uid in ids:
    base_level = {
        "FOODS_1": 50,
        "BEV_2": 80,
        "DAIRY_3": 40,
    }[uid]

    seasonal = np.sin(np.linspace(0, 3 * np.pi, len(dates))) * 10
    noise = rng.normal(scale=5, size=len(dates))
    trend = np.linspace(0, 15, len(dates))

    if uid == "DAIRY_3":
        y = base_level + seasonal + noise              # mostly flat-ish
    else:
        y = base_level + seasonal + noise + trend      # trending

    for d, v in zip(dates, y):
        rows.append({
            "unique_id": uid,
            "ds": d,
            "y": float(max(v, 0.0)),   # no negatives
        })

df_actuals = pd.DataFrame(rows)
df_actuals["department"] = df_actuals["unique_id"].str.split("_").str[0]
df_actuals.head()
```
# 5. Quick Start

```{python}
from tsforge.plots.charts import plot_timeseries

fig = plot_timeseries(
    df=df_actuals,
    id_col="unique_id",
    date_col="ds",
    value_col="y"
)

fig
```

---

# 6. Create a Forecast Dataset
Forecasts must match the identifiers in `df_actuals`.
We simulate a simple uplift-based forecast with 80% and 95% prediction intervals.

```{python}
# -----------------------------
# FORECAST: df_fcst (single model + 80/95 PIs)
# -----------------------------
h = 14
fc_dates = pd.date_range(df_actuals["ds"].max() + pd.Timedelta(days=1),
                         periods=h, freq="D")

rows = []
for uid in ids:
    sub = df_actuals[df_actuals["unique_id"] == uid]
    base_last = sub["y"].iloc[-1]

    seasonal = np.sin(np.linspace(0, 2 * np.pi, h)) * 8
    noise = rng.normal(scale=3, size=h)
    trend = np.linspace(0, 5, h)

    mean = base_last + seasonal + trend
    yhat = mean + noise

    lo80 = yhat - 5
    hi80 = yhat + 5
    lo95 = yhat - 8
    hi95 = yhat + 8

    for d, yh, lo8, hi8, lo9, hi9 in zip(fc_dates, yhat, lo80, hi80, lo95, hi95):
        rows.append({
            "unique_id": uid,
            "ds": d,
            "yhat": float(yh),
            "yhat-lo-80": float(lo8),
            "yhat-hi-80": float(hi8),
            "yhat-lo-95": float(lo9),
            "yhat-hi-95": float(hi9),
        })

df_fcst = pd.DataFrame(rows)
df_fcst["department"] = df_fcst["unique_id"].str.split("_").str[0]

# -----------------------------
# FORECAST: df_fcst_multi (two models)
# -----------------------------
rows = []
for uid in ids:
    base_fc = df_fcst[df_fcst["unique_id"] == uid].copy()

    for model_name, bias in [("Naive", 0.0), ("ML", 3.0)]:
        yhat = base_fc["yhat"] + bias

        for (_, r), yh in zip(base_fc.iterrows(), yhat):
            rows.append({
                "unique_id": uid,
                "ds": r["ds"],
                "model": model_name,
                "yhat": float(yh),
                "yhat-lo-80": float(yh - 5),
                "yhat-hi-80": float(yh + 5),
            })

df_fcst_multi = pd.DataFrame(rows)

df_fcst.head()

```
Prediction intervals are essential for inventory safety stock, risk assessment, and replenishment planning.

# 7. Global Events
Global events apply to all series.

Examples:

- Holidays
- Company-wide promotions
- Weather disruptions affecting supply chain

```{python}
# -----------------------------
# EVENTS: events_df
# -----------------------------

events_global = pd.DataFrame({
    "ds": pd.to_datetime([
        "2020-01-15",   # in-history promo
        "2020-02-14",   # Valentine's
        "2020-03-01",   # price change
        "2020-04-01",   # event during forecast horizon
    ]),
    "event": ["Promo A", "Valentine's", "Price Change", "Spring Reset"],
})
events_global["ds"] = pd.to_datetime(events_global["ds"])
events_global.head()

```

# 8. Local Events (Per-ID)
Local events apply only to a specific item or department.

```{python}
events_local = pd.DataFrame({
    "unique_id": ["BEV_2", "BEV_2"],
    "ds": ["2020-03-10", "2020-02-28"],
    "event": ["Packaging Change", "Shelf Reset"]
})

events_local["ds"] = pd.to_datetime(events_local["ds"])
events_local.head()

```

# 9. Anomalies
An anomaly dataset can be generated from:

- Outlier detection
- QC rules
- Unusually high/low sales

TSForge expects:

- unique_id
- ds
- flag column (default: anom_flag)

```{python}
# -----------------------------
# ANOMALIES: anoms_df
# -----------------------------
anom_rows = []
for uid in ids:
    sub = df_actuals[df_actuals["unique_id"] == uid]
    # pick 2 random dates from the middle of history
    sample_dates = sub["ds"].iloc[20:70].sample(2, random_state=hash(uid) % 2**32)
    for d in sample_dates:
        anom_rows.append({"unique_id": uid, "ds": d})

anoms_df = pd.DataFrame(anom_rows)

anoms_df.head()

```

# 10. Basic Overlay Plotly
The overlay mode plots all selected series together.

```{python}
fig = plot_timeseries(
    df=df_actuals,
    forecast=df_fcst,
    id_col="unique_id",
    date_col="ds",
    value_col="y",
    level=[80, 95],
    events_global=events_global,
    events_local=events_local,
    anomalies=anoms_df,
    mode="overlay",
    theme="fa",
)
fig

```

# 11. Faceted Small Multiples
Great for diagnostic inspection across many IDs.

```{python}
fig = plot_timeseries(
    df=df_actuals,
    forecast=df_fcst,
    id_col="unique_id",
    date_col="ds",
    value_col="y",
    level=[80, 95],
    events_global=events_global,
    events_local=events_local,
    anomalies=anoms_df,
    mode="facet",
    theme="mckinsey",
)
fig

```

# 12. Dropdown Mode (Interactive Selector)
Dropdown mode reduces visual clutter when many IDs exist.

```{python}
fig = plot_timeseries(
    df=df_actuals,
    forecast=df_fcst,
    id_col="unique_id",
    date_col="ds",
    value_col="y",
    level=[80, 95],
    events_global=events_global,
    events_local=events_local,
    anomalies=anoms_df,
    mode="dropdown",
    theme="minimal",
)
fig

```

# 13. Styling Options
The dark theme is optimized for:

- Presentations
- Videos
- Demos
- High-contrast environments

# Plot Styling
TSForge provides a simple, clean way to customize titles, subtitles, axis labels, and layout elements using the `style` dictionary.

This allows you to override theme defaults without touching Plotly directly.
```{python}
fig = plot_timeseries(
    df=df_actuals,
    id_col="unique_id",
    date_col="ds",
    value_col="y",
    style={
        "title": "Demand With Forecast",
        "subtitle": "Styled using the TSForge 'style' dictionary",
        "x_title": "Date",
        "y_title": "Units Sold",
        "font_size": 14,
        "background": "white",
    },
    theme="fa",
)
fig
```


## Event Styling

```{python}
events_config = {
  "color": "#444",
  "opacity": 0.85,
  "stagger_labels": True
}

plot_timeseries(
  df_actuals,
  id_col="unique_id",
  date_col="ds",
  value_col="y",
  events_global=events_global,
  events_config=events_config,
)
```

## Anomaly Styling
```{python}
plot_timeseries(
  df_actuals,
  id_col="unique_id",
  date_col="ds",
  value_col="y",
  anomalies=anoms_df,
  anomalies_config={
    "color": "crimson",
    "marker_symbol": "x",
    "marker_size": 10
  }
)
```

## Theme Styling
```{python}
fig = plot_timeseries(
    df=df_actuals,
    id_col="unique_id",
    date_col="ds",
    value_col="y",
    events_global=events_global,
    anomalies=anoms_df,
    mode="overlay",
    theme="dark",
)
fig

```



# 14. Parameter Reference
## Core Inputs

| Parameter | Description |
|----------|-------------|
| `df` | Input actuals DataFrame. |
| `id_col` | Column identifying unique series (e.g., item/store). |
| `date_col` | Timestamp column (must be coercible to datetime). |
| `value_col` | Actual observed target column. |

### Optional Inputs — Forecasts

| Parameter | Description |
|----------|-------------|
| `forecast` | Forecast DataFrame containing `yhat` and prediction interval columns. |
| `forecast_value_col` | Name of the point forecast column (default: `yhat`). |
| `level` | List of uncertainty interval levels (e.g., `[80, 95]`). |
| `lo_pattern` | Pattern for lower PI column names. |
| `hi_pattern` | Pattern for upper PI column names. |


## Events 

| Parameter | Meaning |
|----------|---------|
| `events_global` | Events that apply to **all** series. |
| `events_local` | Events tied to a specific `unique_id`. |
| `events` | Inline event column in `df` (boolean/string). |
| `anomalies` | Either a column name or a DataFrame of anomaly flags. |
| `anomaly_flag_value` | Value representing anomaly when using inline flag. |

## Anomalies
| Parameter | Description |
|----------|-------------|
| `anomalies` | Either a column name or a DataFrame of anomaly flags. |
| `anomaly_flag_value` | Value representing anomaly when using inline flag. |

## Rendering

| Parameter | Description |
|----------|-------------|
| `theme` | fa / mckinsey / minimal / dark |
| `smooth_window` | Moving window smoother |
| `style` | Title + axis labels |

## Modes

| Mode | Description |
|------|-------------|
| `overlay` | All series plotted on one set of axes. |
| `facet` | Small multiples (one series per subplot). |
| `dropdown` | Single view with an interactive selector. |

## Themes

| Theme | Description |
|--------|-------------|
| `fa` | Forecast Academy brand (default). |
| `mckinsey` | Consulting-grade clean style. |
| `minimal` | Scandinavian-style simplicity. |
| `dark` | High-contrast dark mode optimized for demos. |


## Styling, Themes, & Titles
### General Styling (`style=`)
| Key          | Description                                    |
|--------------|------------------------------------------------|
| `title`      | Main chart title                               |
| `subtitle`   | Secondary subtitle shown above the plot        |
| `x_title`    | X-axis label                                   |
| `y_title`    | Y-axis label                                   |
| `font_size`  | Override theme font size                       |
| `font_family`| Override theme font                            |
| `background` | Plot & paper background override               |

### Styling Events (`events_config=`)
You can customize event appearance:

| Key              | Description                                        |
|------------------|----------------------------------------------------|
| `color`          | Vertical event line + label color                  |
| `opacity`        | Transparency of vertical event lines               |
| `stagger_labels` | Whether to stagger event labels to avoid overlap   |
| `line_width`     | (Optional) Width of event lines                    |
| `label_font_size`| (Optional) Font size of event labels               |


### Styling Anomalies (`anomalies_config=`)
Customize anomaly marker appearance:

| Key             | Description                                         |
|-----------------|-----------------------------------------------------|
| `color`         | Marker color for anomalies                          |
| `marker_symbol` | Plotly symbol (e.g., `x`, `circle`, `diamond`)      |
| `marker_size`   | Marker size                                         |
| `line_width`    | (Optional) Border width for anomaly markers         |
| `opacity`       | (Optional) Opacity of anomaly markers               |


# 15. Summary
In this tutorial, you learned how to use TSForge’s plot_timeseries() to visualize:

- Historical actuals
- Forecasts
- Prediction intervals
- Global & local events
- Anomalies
- Multiple themes
- Three visualization modes

This function provides a **best-in-class visualization layer** for professional forecasting workflows.